name: SAP CPI Backup Workflow Final

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1' # Toda segunda-feira à meia-noite

jobs:
  backup_job:
    runs-on: ubuntu-latest

    steps:

      # 1. Checkout do repositório
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Gerar OAuth Token
      - name: Get OAuth Token
        id: token_step
        run: |
          echo "Gerando token OAuth..."

          # Desabilita history expansion (evita erro com ! no client_id)
          set +H

          # Gera Basic Auth em Base64
          BASIC_AUTH=$(echo -n "${{ secrets.CPI_CLIENT_ID }}:${{ secrets.CPI_CLIENT_SECRET }}" | base64)

          RESPONSE=$(curl -s -X POST "${{ secrets.CPI_TOKEN_URL }}" \
            -H "Authorization: Basic $BASIC_AUTH" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials")

          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "ERRO: Falha na autenticação BTP."
            echo "Resposta completa:"
            echo "$RESPONSE"
            exit 1
          fi

          echo "Token obtido com sucesso"
          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      # 3. Download do Package ZIP
      - name: Download CPI Package
        run: |
          echo "Iniciando download do pacote CPI..."

          PACKAGE_ID="GitHub_API"  # Alterar para o ID técnico do seu pacote

          mkdir -p backups

          curl -L -X GET "$
