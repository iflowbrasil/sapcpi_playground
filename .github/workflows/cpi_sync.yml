name: SAP CPI Backup Workflow Final

on:
  workflow_dispatch: # ExecuÃ§Ã£o manual (Aba Actions)
  schedule:
    - cron: '0 0 * * 1' # AutomÃ¡tico: Toda segunda-feira Ã  meia-noite

jobs:
  backup_job:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Preparar ambiente na mÃ¡quina virtual
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Obter Token e injetar no Ambiente (GITHUB_ENV)
      - name: Get OAuth Token
        id: token_step
        run: |
          # Chamada POST para o BTP
          RESPONSE=$(curl -s -X POST "${{ secrets.CPI_TOKEN_URL }}?grant_type=client_credentials" \
          -u "${{ secrets.CPI_CLIENT_ID }}:${{ secrets.CPI_CLIENT_SECRET }}")
          
          # Extrai o token
          TOKEN=$(echo $RESPONSE | jq -r '.access_token')
          
          # VALIDAÃ‡ÃƒO: Se o token falhar, para o processo aqui com erro claro
          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
            echo "âŒ ERRO: Falha na autenticaÃ§Ã£o BTP. Resposta: $RESPONSE"
            exit 1
          fi
          
          # Injeta o token globalmente no Job para ser usado como ${{ env.ACCESS_TOKEN }}
          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      # 3. Download do Artefato ZIP (OData Binary)
      - name: Download CPI Package
        run: |
          # IMPORTANTE: Mude 'GitHub_API' para o ID TÃ©cnico do SEU pacote
          # O sufixo \$value extrai o binÃ¡rio ZIP real
          curl -L -X GET "${{ secrets.CPI_INTEGRATION_URL }}/api/v1/IntegrationPackages('GitHub_API')/\$value" \
          -H "Authorization: Bearer ${{ env.ACCESS_TOKEN }}" \
          --output "backups/package_$(date +'%Y%m%d').zip" --create-dirs

      # 4. Versionamento AutomÃ¡tico no Git
      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "actions@github.com"
          
          git add backups/
          
          # Verifica se o arquivo ZIP realmente mudou antes de fazer o commit
          if git diff --cached --quiet; then
            echo "âœ… Sem alteraÃ§Ãµes no pacote CPI desde o Ãºltimo backup."
          else
            git commit -m "ðŸ“¦ Automated Backup CPI - $(date +'%d/%m/%Y')"
            git push
          fi
