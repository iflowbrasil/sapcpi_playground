jobs:
  backup_cpi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get OAuth Token
        # Usamos GITHUB_OUTPUT para garantir que o token saia deste passo
        id: token_step
        run: |
          RESPONSE=$(curl -s -X POST "${{ secrets.CPI_TOKEN_URL }}?grant_type=client_credentials" \
          -u "${{ secrets.CPI_CLIENT_ID }}:${{ secrets.CPI_CLIENT_SECRET }}")
          TOKEN=$(echo $RESPONSE | jq -r '.access_token')
          echo "atoken=$TOKEN" >> $GITHUB_OUTPUT

      - name: Download Integration Package
        run: |
          # Criar pasta antes
          mkdir -p backups
          
          # Usamos o token vindo do passo anterior via steps.token_step.outputs.atoken
          # IMPORTANTE: Substitua 'SEU_ID_REAL' pelo ID do seu pacote (ex: My_Package_ID)
          curl -L -X GET "${{ secrets.CPI_INTEGRATION_URL }}/api/v1/IntegrationPackages('SEU_ID_REAL')/\$value" \
          -H "Authorization: Bearer ${{ steps.token_step.outputs.atoken }}" \
          --output "backups/package_$(date +'%Y%m%d').zip"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add backups/
          git commit -m "Backup CPI: $(date +'%d-%m-%Y')" || echo "Sem mudan√ßas"
          git push
