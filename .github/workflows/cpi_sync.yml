name: SAP CPI Backup Workflow Final

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  backup_job:
    runs-on: ubuntu-latest

    steps:

      # 1. Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Gerar OAuth Token (SEM Basic Auth)
      - name: Get OAuth Token
        shell: bash
        env:
          CLIENT_ID: ${{ secrets.CPI_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CPI_CLIENT_SECRET }}
          TOKEN_URL: ${{ secrets.CPI_TOKEN_URL }}
        run: |
          set -e

          echo "Gerando token OAuth..."

          RESPONSE=$(curl -s --location --request POST "$TOKEN_URL" \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=client_credentials" \
            --data-urlencode "client_id=$CLIENT_ID" \
            --data-urlencode "client_secret=$CLIENT_SECRET")

          echo "Resposta recebida."

          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Falha na autenticação BTP."
            echo "$RESPONSE"
            exit 1
          fi

          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "Token gerado com sucesso."

      # 3. Download do Package
      - name: Download CPI Package
        shell: bash
        env:
          CPI_RUNTIME_URL: ${{ secrets.CPI_RUNTIME_URL }}
        run: |
          set -e

          echo "Iniciando download do pacote CPI..."

          PACKAGE_ID="GitHub_API"
          mkdir -p backups

          curl -L --request GET "$CPI_RUNTIME_URL/api/v1/IntegrationPackages('${PACKAGE_ID}')/\$value" \
            --header "Authorization: Bearer $ACCESS_TOKEN" \
            --fail \
            --output "backups/package_$(date +'%Y%m%d').zip"

          echo "Download concluído."

      # 4. Commit se houver alteração
      - name: Commit and Push
        shell: bash
        run: |
          set -e

          git config --global user.name "GitHub Action Bot"
          git config --global user.email "actions@github.com"

          git add backups/

          if git diff --cached --quiet; then
            echo "Sem alterações no pacote CPI desde o último backup."
          else
            git commit -m "Automated Backup CPI - $(date +'%d/%m/%Y')"
            git push
            echo "Backup versionado com sucesso."
          fi
